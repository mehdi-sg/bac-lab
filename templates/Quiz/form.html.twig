{% extends 'back_base.html.twig' %}

{% block title %}{{ edit ? 'Modifier' : 'Nouveau' }} Quiz - Admin{% endblock %}

{% block page_title %}{{ edit ? 'Modifier le Quiz' : 'Nouveau Quiz' }}{% endblock %}
{% block page_subtitle %}{{ edit ? 'Mise à jour des informations du quiz' : 'Créer un nouveau quiz' }}{% endblock %}

{% block stylesheets %}
<style>
    .form-wrapper {
        max-width: 820px;
        margin: 0 auto;
    }

    /* ── Alert erreur ────────────────────────────── */
    .alert-error {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px 18px;
        border-radius: var(--radius);
        border: 1px solid rgba(255,77,141,0.30);
        background: rgba(255,77,141,0.10);
        color: #FF4D8D;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 22px;
    }
    .alert-error ul {
        margin: 0;
        padding-left: 18px;
    }
    .alert-error li { margin-bottom: 4px; }

    /* ── Card de formulaire ─────────────────────── */
    .form-card {
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        backdrop-filter: blur(14px);
        box-shadow: 0 18px 50px rgba(0,0,0,0.20);
        padding: 36px;
        margin-bottom: 20px;
    }

    .form-card-title {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
    }

    .form-card-icon {
        width: 46px;
        height: 46px;
        border-radius: 14px;
        background: var(--grad1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .form-card-title h2 {
        font-size: 18px;
        font-weight: 900;
        margin: 0;
    }

    .form-card-title p {
        margin: 3px 0 0;
        color: var(--muted);
        font-size: 13px;
        font-weight: 600;
    }

    /* ── Groups ─────────────────────────────────── */
    .form-group {
        margin-bottom: 22px;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 800;
        color: var(--muted);
        margin-bottom: 8px;
        letter-spacing: .03em;
        text-transform: uppercase;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.22);
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        font-weight: 600;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        appearance: none;
        -webkit-appearance: none;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: rgba(234,240,255,0.30);
        font-weight: 500;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        border-color: rgba(109,91,255,0.60);
        background: rgba(0,0,0,0.30);
        box-shadow: 0 0 0 3px rgba(109,91,255,0.15);
    }

    .form-group select option {
        background: #0B1020;
        color: var(--text);
    }

    .form-group textarea {
        min-height: 110px;
        resize: vertical;
    }

    /* Champ avec erreur */
    .form-group.has-error input,
    .form-group.has-error textarea,
    .form-group.has-error select {
        border-color: rgba(255,77,141,0.55);
        box-shadow: 0 0 0 3px rgba(255,77,141,0.12);
    }

    .field-error {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        font-weight: 700;
        color: #FF4D8D;
    }

    .help-text {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
    }

    /* ── Grid 2 colonnes ────────────────────────── */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
    }

    /* ── Section séparée (Classification) ───────── */
    .form-section {
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.03);
        padding: 24px;
        margin-bottom: 22px;
    }

    .form-section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        font-weight: 900;
        color: var(--text);
    }

    .form-section-title .section-icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: var(--grad3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
    }

    /* ── Refresh button ─────────────────────────── */
    .btn-refresh {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 7px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        color: var(--muted);
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
        font-family: inherit;
    }

    .btn-refresh:hover {
        background: rgba(255,255,255,0.09);
        border-color: rgba(255,255,255,0.18);
        color: var(--text);
    }

    /* ── Actions ────────────────────────────────── */
    .form-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-top: 10px;
        flex-wrap: wrap;
    }

    .btn-save {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        border-radius: 14px;
        border: 1px solid rgba(109,91,255,0.45);
        background: var(--grad1);
        color: #fff;
        font-weight: 800;
        font-size: 14px;
        cursor: pointer;
        font-family: inherit;
        transition: opacity 0.2s, transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 6px 24px rgba(109,91,255,0.28);
    }

    .btn-save:hover {
        opacity: .88;
        transform: translateY(-2px);
        box-shadow: 0 10px 32px rgba(109,91,255,0.38);
    }

    .btn-cancel {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 22px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        color: var(--muted);
        font-weight: 800;
        font-size: 14px;
        text-decoration: none;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
    }

    .btn-cancel:hover {
        background: rgba(255,255,255,0.09);
        border-color: rgba(255,255,255,0.18);
        color: var(--text);
    }

    @media (max-width: 768px) {
        .form-row   { grid-template-columns: 1fr; }
        .form-card  { padding: 22px; }
        .form-actions { flex-direction: column; align-items: stretch; }
        .btn-save, .btn-cancel { justify-content: center; }
    }
</style>
{% endblock %}

{% block body %}
<div class="form-wrapper">

    {# ── Erreurs de validation ────────────────── #}
    {% if errors is defined and errors is not empty %}
        <div class="alert-error">
            <i class="fa-solid fa-circle-exclamation" style="margin-top:2px;flex-shrink:0;"></i>
            <ul>
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <div class="form-card">

        {# Titre de la card #}
        <div class="form-card-title">
            <div class="form-card-icon">
                <i class="fa-solid fa-{{ edit ? 'pen-to-square' : 'plus' }}"></i>
            </div>
            <div>
                <h2>{{ edit ? 'Modifier le Quiz' : 'Nouveau Quiz' }}</h2>
                <p>{{ edit ? 'Mettez à jour les informations ci-dessous' : 'Remplissez les champs pour créer un quiz' }}</p>
            </div>
        </div>

        <form method="POST">
            <input type="hidden" name="_token" value="{{ csrf_token('quiz_form') }}">

            {# Titre #}
            <div class="form-group">
                <label for="titre">Titre du Quiz <span style="color:#FF4D8D">*</span></label>
                <input
                    type="text"
                    id="titre"
                    name="titre"
                    value="{{ (old.titre ?? quiz.titre ?? '') }}"
                    placeholder="Ex : Quiz de Mathématiques — Chapitre 1"
                >
            </div>

            {# Description #}
            <div class="form-group">
                <label for="description">Description</label>
                <textarea
                    id="description"
                    name="description"
                    placeholder="Décrivez brièvement le contenu du quiz..."
                >{{ (old.description ?? quiz.description ?? '') }}</textarea>
            </div>

            {# Niveau + Durée #}
            <div class="form-row">
                <div class="form-group">
                    <label for="niveau">Niveau <span style="color:#FF4D8D">*</span></label>
                    <select id="niveau" name="niveau">
                        <option value="">-- Sélectionner --</option>
                        <option value="Facile"    {{ ((old.niveau ?? quiz.niveau ?? '') == 'Facile')    ? 'selected' : '' }}>Facile</option>
                        <option value="Moyen"     {{ ((old.niveau ?? quiz.niveau ?? '') == 'Moyen')     ? 'selected' : '' }}>Moyen</option>
                        <option value="Difficile" {{ ((old.niveau ?? quiz.niveau ?? '') == 'Difficile') ? 'selected' : '' }}>Difficile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="duree">Durée (minutes) <span style="color:#FF4D8D">*</span></label>
                    <input
                        type="number"
                        id="duree"
                        name="duree"
                        value="{{ (old.duree ?? quiz.duree ?? 20) }}"
                        min="1"
                        max="180"
                        placeholder="20"
                    >
                    <span class="help-text">Entre 1 et 180 minutes</span>
                </div>
            </div>

            {# Section Classification #}
            <div class="form-section">
                <div class="form-section-title">
                    <div class="section-icon"><i class="fa-solid fa-book-open"></i></div>
                    Classification
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="matiere_id">Matière <span style="color:#FF4D8D">*</span></label>
                        <select id="matiere_id" name="matiere_id">
                            <option value="">-- Sélectionner une matière --</option>
                            {% for matiere in matieres %}
                                <option
                                    value="{{ matiere.id }}"
                                    data-filiere="{{ matiere.filiere.id }}"
                                    {{ ((old.matiere_id ?? (quiz.matiere.id ?? '')) == matiere.id) ? 'selected' : '' }}
                                >{{ matiere.nom }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" name="action" value="refresh_chapitres" class="btn-refresh">
                            <i class="fa-solid fa-rotate"></i> Rafraîchir les chapitres
                        </button>
                        {% if old is defined and old.matiere_id is defined and old.matiere_id is empty and errors is defined and errors|length > 0 %}
                            <span class="field-error"><i class="fa-solid fa-triangle-exclamation"></i> Ce champ est obligatoire</span>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="chapitre_id">Chapitre <span style="color:#FF4D8D">*</span></label>
                        <select id="chapitre_id" name="chapitre_id">
                            <option value="">-- Sélectionner un chapitre --</option>
                            {% if chapitres is defined and chapitres is not empty %}
                                {% for chapitre in chapitres %}
                                    <option
                                        value="{{ chapitre.id }}"
                                        {{ ((old.chapitre_id ?? (quiz.chapitre.id ?? '')) == chapitre.id) ? 'selected' : '' }}
                                    >{{ chapitre.titre }}</option>
                                {% endfor %}
                            {% elseif old.matiere_id is defined and old.matiere_id > 0 %}
                                <option value="">Cliquez sur "Rafraîchir" pour charger</option>
                            {% else %}
                                <option value="">-- Sélectionnez d'abord une matière --</option>
                            {% endif %}
                        </select>
                        {% if old is defined and old.chapitre_id is defined and old.chapitre_id is empty and errors is defined and errors|length > 0 %}
                            <span class="field-error"><i class="fa-solid fa-triangle-exclamation"></i> Ce champ est obligatoire</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Actions #}
            <div class="form-actions">
                <button type="submit" class="btn-save">
                    <i class="fa-solid fa-floppy-disk"></i>
                    {{ edit ? 'Enregistrer les modifications' : 'Créer le Quiz' }}
                </button>
                <a href="{{ path('admin_quiz_index') }}" class="btn-cancel">
                    <i class="fa-solid fa-xmark"></i> Annuler
                </a>
            </div>

        </form>
    </div>

</div>
{% endblock %}