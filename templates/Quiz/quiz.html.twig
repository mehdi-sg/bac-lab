{% extends 'base.html.twig' %}

{% block title %}Quiz & Tests - BacLab{% endblock %}

{% block css %}
    {{ parent() }}
    <style>
        .quiz-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ddd;
            color: #666;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: linear-gradient(to right, #2d5be3, #1a3db8);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-title {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .step.active .step-title {
            color: #2d5be3;
            font-weight: 600;
        }
        
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .selection-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .selection-card:hover {
            border-color: #2d5be3;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(45, 91, 227, 0.1);
        }
        
        .selection-card.selected {
            border-color: #2d5be3;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
        }
        
        .selection-card .icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .selection-card h4 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .selection-card .chapitre-contenu {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
            line-height: 1.5;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: left;
        }
        
        .selection-card p {
            font-size: 13px;
            color: #666;
            margin: 0;
        }
        
        .quiz-summary {
            background: white;
            border-radius: 12px;
            padding: 30px;
            border-left: 4px solid #2d5be3;
            margin-top: 30px;
            display: none;
        }
        
        .quiz-summary.show {
            display: block;
            animation: fadeInUp 0.5s;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: 600;
            color: #555;
        }
        
        .summary-value {
            color: #2d5be3;
            font-weight: 600;
        }
        
        .btn-start-quiz {
            background: linear-gradient(to right, #2d5be3, #1a3db8);
            color: white;
            padding: 15px 50px;
            border-radius: 50px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin-top: 20px;
        }
        
        .btn-start-quiz:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(45, 91, 227, 0.3);
            color: white;
            text-decoration: none;
        }
        
        .btn-start-quiz:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn-nav {
            padding: 12px 30px;
            border-radius: 25px;
            border: 2px solid #2d5be3;
            background: white;
            color: #2d5be3;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-nav:hover {
            background: #2d5be3;
            color: white;
        }
        
        .btn-nav.next {
            background: #2d5be3;
            color: white;
        }
        
        .btn-nav.next:hover {
            background: #1a3db8;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
{% endblock %}

{% block body %}
<div class="slider-area" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="slider-height2 d-flex align-items-center">
        <div class="container">
            <div class="row">
                <div class="col-xl-12">
                    <div class="hero-cap text-center">
                        <h2 style="color: white;">Quiz & Tests de R√©vision</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 18px;">√âvaluez vos connaissances et progressez √† votre rythme</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="about-area section-padding">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                
                <!-- Indicateur d'√©tapes -->
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-title">Choisir une fili√®re</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-title">Choisir une mati√®re</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-title">Choisir un chapitre</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-title">Choisir le niveau</div>
                    </div>
                </div>

                <!-- S√©lecteur de Quiz -->
                <div class="quiz-selector">
                    
                    <!-- √âtape 1: S√©lection de la fili√®re -->
                    <div id="step-filiere" class="step-content">
                        <h3 class="text-center mb-4">S√©lectionnez votre fili√®re</h3>
                        <div id="filieres-grid" class="selection-grid">
                            <!-- Les fili√®res seront charg√©es dynamiquement depuis la base de donn√©es -->
                            <p class="text-center">Chargement des fili√®res...</p>
                        </div>
                    </div>

                    <!-- √âtape 2: S√©lection de la mati√®re -->
                    <div id="step-matiere" class="step-content hidden">
                        <h3 class="text-center mb-4">S√©lectionnez une mati√®re</h3>
                        <div id="matieres-grid" class="selection-grid">
                            <!-- Les mati√®res seront charg√©es dynamiquement depuis la base de donn√©es -->
                            <p class="text-center">S√©lectionnez d'abord une fili√®re</p>
                        </div>
                    </div>

                    <!-- √âtape 3: S√©lection du chapitre -->
                    <div id="step-chapitre" class="step-content hidden">
                        <h3 class="text-center mb-4">S√©lectionnez un chapitre</h3>
                        <div id="chapitres-grid" class="selection-grid">
                            <!-- Les chapitres seront charg√©s dynamiquement ici -->
                        </div>
                    </div>

                    <!-- √âtape 4: S√©lection du niveau -->
                    <div id="step-niveau" class="step-content hidden">
                        <h3 class="text-center mb-4">S√©lectionnez le niveau de difficult√©</h3>
                        <div class="selection-grid">
                            <div class="selection-card" data-niveau="facile">
                                <div class="icon">üòä</div>
                                <h4>Facile</h4>
                                <p>Questions de base</p>
                            </div>
                            <div class="selection-card" data-niveau="moyen">
                                <div class="icon">ü§ì</div>
                                <h4>Moyen</h4>
                                <p>Questions interm√©diaires</p>
                            </div>
                            <div class="selection-card" data-niveau="difficile">
                                <div class="icon">üéì</div>
                                <h4>Difficile</h4>
                                <p>Questions avanc√©es</p>
                            </div>
                        </div>
                    </div>

                    <!-- Boutons de navigation -->
                    <div class="navigation-buttons">
                        <button class="btn-nav prev hidden" id="btn-prev">‚Üê Pr√©c√©dent</button>
                        <button class="btn-nav next" id="btn-next" disabled>Suivant ‚Üí</button>
                    </div>
                </div>

                <!-- R√©sum√© et bouton de d√©marrage -->
                <div class="quiz-summary" id="quiz-summary">
                    <h3 class="text-center mb-4">üìù R√©capitulatif de votre quiz</h3>
                    
                    <div id="quiz-info-container">
                        <div class="summary-item">
                            <span class="summary-label">Fili√®re :</span>
                            <span class="summary-value" id="summary-filiere">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Mati√®re :</span>
                            <span class="summary-value" id="summary-matiere">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Chapitre :</span>
                            <span class="summary-value" id="summary-chapitre">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Niveau :</span>
                            <span class="summary-value" id="summary-niveau">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Nombre de questions :</span>
                            <span class="summary-value" id="summary-nb-questions">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Dur√©e estim√©e :</span>
                            <span class="summary-value" id="summary-duree">-</span>
                        </div>
                    </div>
                    
                    <div id="quiz-not-found" class="alert alert-warning text-center" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="quiz-not-found-message">Aucun quiz disponible pour ces crit√®res</span>
                    </div>
                    
                    <div class="text-center" id="quiz-start-container">
                        <button class="btn-start-quiz" id="btn-start-quiz">
                            üöÄ Commencer le Quiz
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block js %}
    {{ parent() }}
    <script>
        // Icons for filieres
        const filiereIcons = {
            'Sciences Math√©matiques': 'üìä',
            'Sciences Exp√©rimentales': 'üî¨',
            'Sciences √âconomiques': 'üí∞',
            'Technologie': '‚öôÔ∏è',
            'Lettres': 'üìö'
        };
        
        // Icons for subjects
        const matiereIcons = {
            'mathematiques': 'üìê',
            'physique': '‚öõÔ∏è',
            'sciences': 'üß¨',
            'informatique': 'üíª',
            'francais': 'üìö',
            'arabe': 'üìñ',
            'anglais': 'üåç',
            'philosophie': 'ü§î'
        };
        
        const chapitreIcons = {
            'Limites': '‚àû',
            'D√©rivabilit√©': 'f\'(x)',
            '√âtude de fonctions': 'üìà',
            'Primitives': '‚à´',
            'Complexes': '‚ÑÇ',
            'G√©om√©trie': 'üìê',
            'M√©canique': 'üéØ',
            '√âlectricit√©': '‚ö°'
        };

        let currentStep = 1;
        let filieresData = [];
        let matieresData = [];
        let currentQuiz = null;
        let selections = {
            filiereId: null,
            filiereNom: null,
            matiereId: null,
            matiereNom: null,
            chapitreId: null,
            chapitreNom: null,
            niveau: null
        };

        // Charger les fili√®res depuis l'API
        async function loadFilieres() {
            try {
                const response = await fetch('{{ path('api_filieres') }}');
                filieresData = await response.json();
                renderFilieres();
            } catch (error) {
                console.error('Erreur lors du chargement des fili√®res:', error);
                // Fallback to hardcoded data if API fails
                renderHardcodedFilieres();
            }
        }

        function renderFilieres() {
            const grid = document.getElementById('filieres-grid');
            if (!grid) {
                setTimeout(renderFilieres, 100);
                return;
            }
            
            grid.innerHTML = '';
            
            if (filieresData.length === 0) {
                grid.innerHTML = '<p class="text-center">Aucune fili√®re disponible</p>';
                return;
            }
            
            filieresData.forEach(filiere => {
                const icon = filiereIcons[filiere.nom] || 'üéì';
                const card = document.createElement('div');
                card.className = 'selection-card';
                card.dataset.filiereId = filiere.id;
                card.dataset.filiereNom = filiere.nom;
                card.innerHTML = `
                    <div class="icon">${icon}</div>
                    <h4>${filiere.nom}</h4>
                    <p>BAC ${filiere.nom}</p>
                `;
                
                card.addEventListener('click', function() {
                    selectFiliere(this);
                });
                
                grid.appendChild(card);
            });
        }

        function renderHardcodedFilieres() {
            const hardcodedFilieres = [
                { id: 'sciences_math', nom: 'Sciences Math√©matiques', niveau: 'Baccalaur√©at' },
                { id: 'sciences_exp', nom: 'Sciences Exp√©rimentales', niveau: 'Baccalaur√©at' },
                { id: 'sciences_eco', nom: 'Sciences √âconomiques', niveau: 'Baccalaur√©at' },
                { id: 'technologie', nom: 'Technologie', niveau: 'Baccalaur√©at' },
                { id: 'lettres', nom: 'Lettres', niveau: 'Baccalaur√©at' }
            ];
            
            filieresData = hardcodedFilieres;
            renderFilieres();
        }

        function selectFiliere(card) {
            document.querySelectorAll('#step-filiere .selection-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selections.filiereId = card.dataset.filiereId;
            selections.filiereNom = card.dataset.filiereNom;
            updateNextButton();
            
            // Charger les mati√®res pour cette fili√®re
            loadMatieres(selections.filiereId);
        }

        // Charger les mati√®res depuis l'API (par fili√®re)
        async function loadMatieres(filiereId) {
            const grid = document.getElementById('matieres-grid');
            grid.innerHTML = '<p class="text-center">Chargement des mati√®res...</p>';
            
            try {
                // Check if filiereId is numeric (API) or string (hardcoded fallback)
                const url = isNaN(filiereId) 
                    ? getHardcodedMatieresUrl(filiereId)
                    : `{{ path('api_matieres_by_filiere', {id: '__ID__'}) }}`.replace('__ID__', filiereId);
                
                const response = await fetch(url);
                matieresData = await response.json();
                renderMatieres();
            } catch (error) {
                console.error('Erreur lors du chargement des mati√®res:', error);
                // Fallback to hardcoded
                matieresData = getHardcodedMatieres(filiereId);
                renderMatieres();
            }
        }

        function getHardcodedMatieresUrl(filiereId) {
            // Return Promise for consistency
            return Promise.resolve(getHardcodedMatieres(filiereId));
        }

        function getHardcodedMatieres(filiereId) {
            const matieresMap = {
                'sciences_math': [
                    { id: 1, nom: 'Math√©matiques' },
                    { id: 2, nom: 'Physique' },
                    { id: 3, nom: 'Informatique' }
                ],
                'sciences_exp': [
                    { id: 4, nom: 'Sciences SVT' },
                    { id: 2, nom: 'Physique' },
                    { id: 5, nom: 'Chimie' }
                ],
                'sciences_eco': [
                    { id: 6, nom: '√âconomie' },
                    { id: 7, nom: 'Gestion' },
                    { id: 8, nom: 'Comptabilit√©' }
                ],
                'technologie': [
                    { id: 9, nom: 'Technologie' },
                    { id: 10, nom: 'Dessin technique' },
                    { id: 11, nom: 'M√©canique' }
                ],
                'lettres': [
                    { id: 12, nom: 'Fran√ßais' },
                    { id: 13, nom: 'Arabe' },
                    { id: 14, nom: 'Anglais' },
                    { id: 15, nom: 'Philosophie' }
                ]
            };
            return matieresMap[filiereId] || [];
        }

        function renderMatieres() {
            const grid = document.getElementById('matieres-grid');
            if (!grid) {
                setTimeout(renderMatieres, 100);
                return;
            }
            
            grid.innerHTML = '';
            
            if (matieresData.length === 0) {
                grid.innerHTML = '<p class="text-center">Aucune mati√®re disponible pour cette fili√®re</p>';
                return;
            }
            
            matieresData.forEach(matiere => {
                const icon = matiereIcons[matiere.nom.toLowerCase()] || 'üìñ';
                const card = document.createElement('div');
                card.className = 'selection-card';
                card.dataset.matiereId = matiere.id;
                card.dataset.matiereNom = matiere.nom;
                card.innerHTML = `
                    <div class="icon">${icon}</div>
                    <h4>${matiere.nom}</h4>
                    <p>Mati√®re</p>
                `;
                
                card.addEventListener('click', function() {
                    selectMatiere(this);
                });
                
                grid.appendChild(card);
            });
        }

        function selectMatiere(card) {
            document.querySelectorAll('#step-matiere .selection-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selections.matiereId = card.dataset.matiereId;
            selections.matiereNom = card.dataset.matiereNom;
            updateNextButton();
            
            // Charger les chapitres
            loadChapitres(selections.matiereId);
        }

        // Charger les chapitres dynamiquement depuis l'API
        async function loadChapitres(matiereId) {
            const grid = document.getElementById('chapitres-grid');
            grid.innerHTML = '<p class="text-center">Chargement des chapitres...</p>';
            
            try {
                // Check if matiereId is numeric (API) or string (hardcoded fallback)
                const url = isNaN(matiereId) 
                    ? getHardcodedChapitresUrl(matiereId)
                    : `{{ path('api_chapitres_by_matiere', {id: '__ID__'}) }}`.replace('__ID__', matiereId);
                
                const response = await fetch(url);
                const chapitres = await response.json();
                renderChapitres(chapitres);
            } catch (error) {
                console.error('Erreur lors du chargement des chapitres:', error);
                // Fallback to hardcoded
                renderChapitres(getHardcodedChapitres(matiereId));
            }
        }

        function getHardcodedChapitresUrl(matiereId) {
            return Promise.resolve(getHardcodedChapitres(matiereId));
        }

        function getHardcodedChapitres(matiereId) {
            // Map of matiere names to chapitres
            const chapitresByMatiere = {
                'Math√©matiques': [
                    { id: 1, titre: 'Limites et Continuit√©' },
                    { id: 2, titre: 'D√©rivabilit√©' },
                    { id: 3, titre: '√âtude de fonctions' },
                    { id: 4, titre: 'Primitives et Int√©grales' },
                    { id: 5, titre: 'Nombres Complexes' },
                    { id: 6, titre: 'G√©om√©trie dans l\'espace' }
                ],
                'Physique': [
                    { id: 1, titre: 'M√©canique du point' },
                    { id: 2, titre: '√âlectricit√©' },
                    { id: 3, titre: 'Oscillations m√©caniques' },
                    { id: 4, titre: 'Optique g√©om√©trique' },
                    { id: 5, titre: 'Ondes' }
                ],
                'Sciences SVT': [
                    { id: 1, titre: 'La g√©n√©tique' },
                    { id: 2, titre: 'L\'immunologie' },
                    { id: 3, titre: 'La g√©ologie' },
                    { id: 4, titre: 'L\'√©cologie' }
                ],
                'Informatique': [
                    { id: 1, titre: 'Algorithmes' },
                    { id: 2, titre: 'Structures de donn√©es' },
                    { id: 3, titre: 'Bases de donn√©es' },
                    { id: 4, titre: 'R√©seaux' }
                ],
                'Fran√ßais': [
                    { id: 1, titre: 'La Bo√Æte √† Merveilles' },
                    { id: 2, titre: 'Antigone' },
                    { id: 3, titre: 'Le Dernier Jour d\'un Condamn√©' },
                    { id: 4, titre: 'Grammaire' }
                ],
                'Arabe': [
                    { id: 1, titre: 'ÿßŸÑŸÜÿ≠Ÿà ŸàÿßŸÑÿµÿ±ŸÅ' },
                    { id: 2, titre: 'ÿßŸÑÿ®ŸÑÿßÿ∫ÿ©' },
                    { id: 3, titre: 'ÿßŸÑÿ£ÿØÿ®' }
                ],
                'Anglais': [
                    { id: 1, titre: 'Grammar' },
                    { id: 2, titre: 'Vocabulary' },
                    { id: 3, titre: 'Reading Comprehension' },
                    { id: 4, titre: 'Writing Skills' }
                ],
                'Philosophie': [
                    { id: 1, titre: 'La Conscience' },
                    { id: 2, titre: 'L\'Inconscient' },
                    { id: 3, titre: 'La Libert√©' },
                    { id: 4, titre: 'Le Devoir' }
                ]
            };
            
            // Try to find by matiere name (case insensitive)
            for (const [key, value] of Object.entries(chapitresByMatiere)) {
                if (matiereId.toLowerCase().includes(key.toLowerCase()) || key.toLowerCase().includes(matiereId.toLowerCase())) {
                    return value;
                }
            }
            
            return [];
        }

        function renderChapitres(chapitres) {
            const grid = document.getElementById('chapitres-grid');
            grid.innerHTML = '';
            
            if (chapitres.length === 0) {
                grid.innerHTML = '<p class="text-center">Aucun chapitre disponible pour cette mati√®re</p>';
                return;
            }
            
            chapitres.forEach(chapitre => {
                const icon = chapitreIcons[chapitre.titre] || 'üìë';
                const card = document.createElement('div');
                card.className = 'selection-card';
                card.dataset.chapitreId = chapitre.id;
                card.dataset.chapitreNom = chapitre.titre;
                
                // Display content (truncate if too long)
                let contenuHtml = '';
                if (chapitre.contenu && chapitre.contenu.trim() !== '') {
                    const contenuText = chapitre.contenu.length > 150 
                        ? chapitre.contenu.substring(0, 150) + '...'
                        : chapitre.contenu;
                    contenuHtml = `<p class="chapitre-contenu">${contenuText}</p>`;
                }
                
                card.innerHTML = `
                    <div class="icon">${icon}</div>
                    <h4>${chapitre.titre}</h4>
                    ${contenuHtml}
                `;
                
                card.addEventListener('click', function() {
                    selectChapitre(this);
                });
                
                grid.appendChild(card);
            });
        }

        function selectChapitre(card) {
            document.querySelectorAll('#step-chapitre .selection-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selections.chapitreId = card.dataset.chapitreId;
            selections.chapitreNom = card.dataset.chapitreNom;
            updateNextButton();
        }

        // Gestion des √©tapes (now 4 steps)
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        function showStep(stepNum) {
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            if (stepNum === 1) {
                document.getElementById('step-filiere').classList.remove('hidden');
                document.getElementById('btn-prev').classList.add('hidden');
            } else if (stepNum === 2) {
                document.getElementById('step-matiere').classList.remove('hidden');
                document.getElementById('btn-prev').classList.remove('hidden');
            } else if (stepNum === 3) {
                document.getElementById('step-chapitre').classList.remove('hidden');
                document.getElementById('btn-prev').classList.remove('hidden');
            } else if (stepNum === 4) {
                document.getElementById('step-niveau').classList.remove('hidden');
                document.getElementById('btn-prev').classList.remove('hidden');
            }
            
            updateStepIndicator();
            updateNextButton();
        }

        function updateNextButton() {
            const btnNext = document.getElementById('btn-next');
            
            if (currentStep === 1 && selections.filiereId) {
                btnNext.disabled = false;
            } else if (currentStep === 2 && selections.matiereId) {
                btnNext.disabled = false;
            } else if (currentStep === 3 && selections.chapitreId) {
                btnNext.disabled = false;
            } else if (currentStep === 4 && selections.niveau) {
                btnNext.disabled = false;
            } else {
                btnNext.disabled = true;
            }
        }

        // S√©lection du niveau
        document.querySelectorAll('#step-niveau .selection-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('#step-niveau .selection-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selections.niveau = this.dataset.niveau;
                updateNextButton();
                showSummary();
            });
        });

        // Navigation (now 4 steps)
        document.getElementById('btn-next').addEventListener('click', function() {
            if (currentStep < 4) {
                currentStep++;
                showStep(currentStep);
            }
        });

        document.getElementById('btn-prev').addEventListener('click', function() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                document.getElementById('quiz-summary').classList.remove('show');
            }
        });

        // Afficher le r√©sum√© et rechercher un quiz correspondant
        async function showSummary() {
            document.getElementById('summary-filiere').textContent = selections.filiereNom || '-';
            document.getElementById('summary-matiere').textContent = selections.matiereNom || '-';
            document.getElementById('summary-chapitre').textContent = selections.chapitreNom || '-';
            document.getElementById('summary-niveau').textContent = selections.niveau ? selections.niveau.charAt(0).toUpperCase() + selections.niveau.slice(1) : '-';
            
            // Reset quiz info
            document.getElementById('summary-nb-questions').textContent = '...';
            document.getElementById('summary-duree').textContent = '...';
            document.getElementById('quiz-info-container').style.display = 'block';
            document.getElementById('quiz-not-found').style.display = 'none';
            document.getElementById('quiz-start-container').style.display = 'block';
            
            if (selections.filiereId && selections.matiereId && selections.chapitreNom && selections.niveau) {
                document.getElementById('quiz-summary').classList.add('show');
                
                // Rechercher un quiz correspondant
                await searchQuiz();
            }
        }

        // Rechercher un quiz dans la base de donn√©es
        async function searchQuiz() {
            const matiereId = isNaN(selections.matiereId) ? selections.matiereId : selections.matiereId;
            const chapitreId = isNaN(selections.chapitreId) ? selections.chapitreId : selections.chapitreId;
            
            try {
                const url = `{{ path('api_quiz_search') }}?matiere=${matiereId}&chapitre=${chapitreId}&niveau=${selections.niveau}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.found && data.quiz) {
                    // Quiz trouv√© - afficher les informations
                    currentQuiz = data.quiz;
                    document.getElementById('summary-nb-questions').textContent = data.quiz.nbQuestions + ' questions';
                    document.getElementById('summary-duree').textContent = data.quiz.duree + ' minutes';
                } else {
                    // Quiz non trouv√© - afficher le message
                    currentQuiz = null;
                    document.getElementById('summary-nb-questions').textContent = '-';
                    document.getElementById('summary-duree').textContent = '-';
                    document.getElementById('quiz-not-found-message').textContent = data.message || 'Aucun quiz disponible pour ces crit√®res';
                    document.getElementById('quiz-not-found').style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur lors de la recherche du quiz:', error);
                // En cas d'erreur, utiliser les valeurs par d√©faut
                document.getElementById('summary-nb-questions').textContent = '10 questions';
                document.getElementById('summary-duree').textContent = '20 minutes';
            }
        }

        // D√©marrer le quiz
        document.getElementById('btn-start-quiz').addEventListener('click', function() {
            // V√©rifier si un quiz a √©t√© trouv√©
            if (!currentQuiz) {
                alert('Aucun quiz disponible pour ces crit√®res. Veuillez choisir d\'autres options.');
                return;
            }
            
            const matiereParam = isNaN(selections.matiereId) ? selections.matiereId : selections.matiereId;
            
            // Rediriger vers la page du quiz avec les param√®tres
            window.location.href = `/quiz/start?matiere=${matiereParam}&chapitre=${encodeURIComponent(selections.chapitreNom)}&niveau=${selections.niveau}`;
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadFilieres();
            showStep(1);
        });
    </script>
{% endblock %}
