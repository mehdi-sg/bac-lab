{% extends 'base.html.twig' %}

{% block title %}BacLab | {{ filiere.nom }}{% endblock %}

{% block body %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    /* --- STYLE DU STEPPER --- */
    .stepper-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .step-num { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.3); text-decoration: none; transition: 0.3s; }
    .step-num.active { background: #ffc107; color: #3b1a77; border-color: #ffc107; transform: scale(1.1); }
    .step-num.done { background: rgba(255,255,255,0.9); color: #764ba2; border-color: #fff; }
    .step-line { width: 40px; height: 2px; background: rgba(255,255,255,0.2); }

    .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 120px 0 90px; clip-path: ellipse(150% 100% at 50% 0%); color: white; }
    
    /* --- STYLE MODE FOCUS --- */
    #focusOverlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.98); z-index: 9999; color: white;
        flex-direction: column; align-items: center; justify-content: center;
        backdrop-filter: blur(10px);
    }
    .timer-text { font-size: 6rem; font-weight: 800; font-family: monospace; margin: 20px 0; color: #ffc107; }
    .btn-focus-launcher { background: rgba(255,255,255,0.15); border: 1px dashed white; color: white; border-radius: 50px; padding: 5px 20px; font-size: 0.9rem; transition: 0.3s; margin-top: 15px; }
    .btn-focus-launcher:hover { background: white; color: #764ba2; }

    /* --- CARTES MATI√àRES --- */
    .matiere-card { border: none; border-radius: 20px; background: #fff; height: 100%; transition: all 0.3s ease; position: relative; }
    .matiere-card:hover { transform: translateY(-8px); box-shadow: 0 14px 28px rgba(0,0,0,0.1); }
    .btn-fav { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 1.4rem; color: #e2e8f0; cursor: pointer; transition: 0.3s; z-index: 10; }
    .btn-fav.is-favorite { color: #ffc107; transform: scale(1.1); }
    .icon-box { width: 60px; height: 60px; background: #f8f9ff; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: #667eea; margin-bottom: 20px; transition: 0.3s; }
    .matiere-card:hover .icon-box { background: #667eea; color: white; transform: rotate(10deg); }
    .btn-modern { background: linear-gradient(to right, #667eea, #764ba2); border: none; color: white !important; border-radius: 50px; padding: 10px 20px; font-weight: 600; }
    .animate-up { animation: fadeInUp 0.7s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="hero-section text-center">
    <div class="container animate-up">
        <div class="stepper-container">
            <a href="{{ path('app_revision_filieres') }}" class="step-num done">1</a>
            <div class="step-line"></div>
            <span class="step-num active">2</span>
            <div class="step-line"></div>
            <span class="step-num disabled">3</span>
        </div>

        <span class="badge bg-white text-primary px-3 py-2 rounded-pill mb-3">Fili√®re : {{ filiere.nom }}</span>
        <h1 class="display-4 fw-bold mb-2">Mes Mati√®res</h1>
        
        <div class="d-flex flex-column align-items-center gap-2 mt-3">
            <button id="filterFavBtn" class="btn btn-filter-fav btn-outline-light rounded-pill px-4" onclick="toggleFilterFav()">
                <i class="fas fa-star me-2"></i> Mes favoris
            </button>
            
            <button onclick="startFocusMode()" class="btn btn-focus-launcher">
                <i class="fas fa-stopwatch me-2"></i> Session Focus 25min (+100 XP)
            </button>
        </div>
    </div>
</div>

<div class="container" style="margin-top: -60px; padding-bottom: 80px;">
    <div class="row justify-content-center" id="matieresGrid">
        {% for m in matieres %}
            <div class="col-lg-4 col-md-6 mb-4 animate-up matiere-item" data-id="{{ m.id }}" style="animation-delay: {{ loop.index * 0.1 }}s">
                <div class="card matiere-card shadow-sm p-4 text-center">
                    <button class="btn-fav" onclick="toggleFav('{{ m.id }}', this)"><i class="fas fa-star"></i></button>
                    
                    <div class="icon-box mx-auto">
                        {% if m.nom|lower matches '/math/' %} <i class="fas fa-calculator fa-lg"></i>
                        {% elseif m.nom|lower matches '/physique/' or m.nom|lower matches '/science/' %} <i class="fas fa-flask fa-lg"></i>
                        {% elseif m.nom|lower matches '/philo/' %} <i class="fas fa-lightbulb fa-lg"></i>
                        {% elseif m.nom|lower matches '/histoire/' or m.nom|lower matches '/g√©o/' %} <i class="fas fa-globe-africa fa-lg"></i>
                        {% elseif m.nom|lower matches '/informatique/' or m.nom|lower matches '/tic/' %} <i class="fas fa-laptop-code fa-lg"></i>
                        {% elseif m.nom|lower matches '/anglais/' or m.nom|lower matches '/fran√ßais/' or m.nom|lower matches '/arabe/' %} <i class="fas fa-language fa-lg"></i>
                        {% elseif m.nom|lower matches '/√©conomie/' or m.nom|lower matches '/gestion/' %} <i class="fas fa-chart-line fa-lg"></i>
                        {% else %} <i class="fas fa-book-open fa-lg"></i> {% endif %}
                    </div>

                    <h3 class="fw-bold h5 mb-3 text-dark">{{ m.nom }}</h3>
                    <a href="{{ path('app_revision_pdf', {'id': m.id}) }}" class="btn btn-modern w-100">Voir les cours <i class="fas fa-arrow-right ms-2"></i></a>
                </div>
            </div>
        {% endfor %}
    </div>
    <div id="emptyFav" class="text-center d-none">
        <div class="bg-white p-5 rounded-4 shadow-sm mx-auto" style="max-width: 500px;">
            <i class="far fa-star fa-3x text-muted mb-3"></i>
            <h5>Aucun favori pour le moment</h5>
        </div>
    </div>
</div>

<div id="focusOverlay">
    <div class="text-center p-4">
        <i class="fas fa-brain fa-3x text-warning mb-4"></i>
        <h2 class="fw-bold">Mode Concentration</h2>
        <p class="opacity-75">R√©vision en cours : <strong>{{ filiere.nom }}</strong></p>
        
        <div id="timerDisplay" class="timer-text">25:00</div>
        
        <div class="d-flex flex-column gap-3 align-items-center">
            <button onclick="stopFocusMode(true)" class="btn btn-outline-danger rounded-pill px-5">Abandonner</button>
            <small class="text-muted">La musique Lo-Fi vous aide √† rester focus...</small>
        </div>
    </div>

    <audio id="focusMusic" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg">
    </audio>
</div>

<script>
// --- LOGIQUE FOCUS ---
let focusInterval;
let timeLeft = 25 * 60;
const music = document.getElementById('focusMusic');

function startFocusMode() {
    document.getElementById('focusOverlay').style.display = 'flex';
    music.play();
    focusInterval = setInterval(() => {
        timeLeft--;
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        document.getElementById('timerDisplay').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) finishSession();
    }, 1000);
}

function stopFocusMode(confirmClose) {
    if (confirmClose && !confirm("Abandonner ? Tu ne gagneras pas tes 100 XP !")) return;
    clearInterval(focusInterval);
    timeLeft = 25 * 60;
    document.getElementById('focusOverlay').style.display = 'none';
    music.pause();
    music.currentTime = 0;
}

function finishSession() {
    stopFocusMode(false);
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    alert("F√©licitations ! Tu as tenu 25 minutes. Tu gagnes +100 XP ! üî•");
    // Optionnel : sauvegarder l'XP
    let xp = parseInt(localStorage.getItem('user_xp')) || 0;
    localStorage.setItem('user_xp', xp + 100);
}

// --- LOGIQUE FAVORIS (EXISTANTE) ---
let showOnlyFavs = false;
function toggleFav(id, btn) {
    btn.classList.toggle('is-favorite');
    let favs = JSON.parse(localStorage.getItem('fav_matieres')) || [];
    if (btn.classList.contains('is-favorite')) { if (!favs.includes(id)) favs.push(id); } 
    else { favs = favs.filter(favId => favId !== id); }
    localStorage.setItem('fav_matieres', JSON.stringify(favs));
    if (showOnlyFavs && !btn.classList.contains('is-favorite')) { btn.closest('.matiere-item').style.display = 'none'; checkEmptyState(); }
}

function toggleFilterFav() {
    const btnFilter = document.getElementById('filterFavBtn');
    showOnlyFavs = !showOnlyFavs;
    btnFilter.classList.toggle('active');
    btnFilter.classList.toggle('btn-warning'); // Change couleur si actif
    const favs = JSON.parse(localStorage.getItem('fav_matieres')) || [];
    document.querySelectorAll('.matiere-item').forEach(item => {
        const id = item.getAttribute('data-id');
        item.style.display = showOnlyFavs ? (favs.includes(id) ? 'block' : 'none') : 'block';
    });
    checkEmptyState();
}

function checkEmptyState() {
    const itemsVisible = document.querySelectorAll('.matiere-item[style="display: block;"]').length;
    document.getElementById('emptyFav').classList.toggle('d-none', !(showOnlyFavs && itemsVisible === 0));
}

document.addEventListener('DOMContentLoaded', () => {
    const favs = JSON.parse(localStorage.getItem('fav_matieres')) || [];
    document.querySelectorAll('.matiere-item').forEach(item => { 
        if (favs.includes(item.getAttribute('data-id'))) item.querySelector('.btn-fav').classList.add('is-favorite'); 
    });
});
</script>
{% endblock %}