{% extends 'base.html.twig' %}

{% block title %}BacLab | {{ matiere.nom }}{% endblock %}

{% block body %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    /* --- DESIGN IDENTIQUE AUX FILIÈRES --- */
    body { background-color: #f8f9fc; }

    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 100px 0 80px;
        clip-path: ellipse(150% 100% at 50% 0%);
        color: white;
    }

    .stepper-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .step-num { 
        width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; 
        font-weight: bold; display: flex; align-items: center; justify-content: center;
        border: 2px solid rgba(255,255,255,0.3); text-decoration: none; transition: 0.3s;
    }
    .step-num.done { background: #fff; color: #764ba2; border-color: #fff; }
    .step-num.active { background: #ffc107; color: #3b1a77; border-color: #ffc107; transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 193, 7, 0.4); }
    .step-line { width: 40px; height: 2px; background: rgba(255,255,255,0.2); }

    /* --- BARRE DE PROGRESSION GLASSMORPHISM --- */
    .progression-panel {
        position: sticky; top: 20px; z-index: 100;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border-radius: 50px; padding: 12px 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        margin-top: -35px;
        border: 1px solid rgba(255,255,255,0.4);
    }

    /* --- CHAPTER CARDS --- */
    .chapter-card {
        border: none; border-radius: 22px;
        transition: all 0.4s cubic-bezier(.25,.8,.25,1);
        background: #fff; height: 100%;
        display: flex; flex-direction: column;
        border-bottom: 4px solid transparent;
    }
    .chapter-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
    
    /* État complété */
    .chapter-card.is-completed { 
        border-bottom-color: #4ade80; 
        background: #f0fff4; 
    }
    .is-completed .check-btn { background: #4ade80 !important; color: white !important; border-color: #4ade80 !important; }

    .icon-box-sm {
        width: 45px; height: 45px; background: #f0f2ff; border-radius: 12px;
        display: flex; align-items: center; justify-content: center; color: #667eea;
    }

    .btn-modern {
        background: linear-gradient(to right, #667eea, #764ba2);
        border: none; color: white !important; border-radius: 50px; font-weight: 600; padding: 12px;
        transition: 0.3s; text-align: center;
    }
    .btn-modern:hover { opacity: 0.9; transform: scale(1.02); }

    /* --- ANIMATIONS & AUDIO --- */
    .animate-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .btn-audio.playing { color: #ff4757; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
</style>

<div class="hero-section text-center">
    <div class="container animate-up">
        <div class="stepper-container">
            <a href="{{ path('app_revision_filieres') }}" class="step-num done"><i class="fas fa-check"></i></a>
            <div class="step-line"></div>
            <a href="{{ path('app_revision_matieres', {id: matiere.filiere.id}) }}" class="step-num done"><i class="fas fa-check"></i></a>
            <div class="step-line"></div>
            <span class="step-num active">3</span>
        </div>
        <h1 class="display-4 fw-bold mb-2">{{ matiere.nom }}</h1>
        <p class="lead opacity-75">Dernière étape : valide chaque chapitre pour gagner de l'XP !</p>
    </div>
</div>

<div class="container pb-5">
    <div class="progression-panel d-flex align-items-center justify-content-between animate-up">
        <div class="d-flex align-items-center flex-grow-1 me-4">
            <span class="fw-bold me-3 text-primary d-none d-md-inline">Progression du module</span>
            <div class="progress flex-grow-1" style="height: 10px; border-radius: 10px; background: #e9ecef;">
                <div id="progBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>
        </div>
        <span id="progText" class="badge rounded-pill bg-success px-3 py-2 fs-6 shadow-sm">0%</span>
    </div>

    <div class="row g-4 mt-4">
        {% for c in chapitres %}
        <div class="col-md-6 col-lg-4 animate-up" style="animation-delay: {{ loop.index0 * 0.1 }}s">
            <div class="card chapter-card shadow-sm p-4" id="card-{{ c.id }}">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="icon-box-sm shadow-sm">
                        <i class="fas fa-bookmark"></i>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-sm rounded-circle btn-audio shadow-sm" 
                                onclick="speak('{{ c.titre|e('js') }}', this)" title="Écouter le titre">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm rounded-circle shadow-sm check-btn" 
                                onclick="toggleComplete('{{ c.id }}')" title="Terminer ce chapitre">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>

                <h5 class="fw-bold mb-3" style="color: #2d3436; min-height: 50px;">{{ c.titre }}</h5>
                <p class="text-muted small mb-4">Clique sur le bouton ci-dessous pour ouvrir le support de cours complet en PDF.</p>
                
                <div class="mt-auto pt-3 border-top">
                    <a href="{{ asset('uploads/pdf/' ~ c.contenu) }}" target="_blank" class="btn btn-modern w-100" onclick="addXP(10)">
                        <i class="fas fa-file-pdf me-2"></i> Ouvrir le Cours
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // 1. Synthèse Vocale (Lecture du titre)
    function speak(text, btn) {
        window.speechSynthesis.cancel();
        let msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'fr-FR';
        msg.onstart = () => btn.classList.add('playing');
        msg.onend = () => btn.classList.remove('playing');
        window.speechSynthesis.speak(msg);
    }

    // 2. Gestion de la complétion & XP
    function toggleComplete(id) {
        let done = JSON.parse(localStorage.getItem('done_chapters')) || [];
        const card = document.getElementById('card-' + id);
        
        if (done.includes(id)) {
            done = done.filter(i => i !== id);
            card.classList.remove('is-completed');
        } else {
            done.push(id);
            card.classList.add('is-completed');
            // Célébration locale
            confetti({
                particleCount: 50,
                spread: 60,
                origin: { y: 0.7 },
                colors: ['#667eea', '#764ba2', '#4ade80']
            });
            addXP(50); // Bonus XP pour chapitre fini
        }
        
        localStorage.setItem('done_chapters', JSON.stringify(done));
        updateProg();
    }

    // 3. Mise à jour de la barre de progression
    function updateProg() {
        let done = JSON.parse(localStorage.getItem('done_chapters')) || [];
        let chaptersOnPage = [];
        {% for c in chapitres %} chaptersOnPage.push('{{ c.id }}'); {% endfor %}
        
        let completedOnThisPage = chaptersOnPage.filter(id => done.includes(id.toString()));
        let total = chaptersOnPage.length;
        let percent = total > 0 ? Math.round((completedOnThisPage.length / total) * 100) : 0;
        
        document.getElementById('progBar').style.width = percent + '%';
        document.getElementById('progText').innerText = percent + '%';

        if (percent === 100 && total > 0) {
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        }
    }

    // 4. Ajouter de l'XP
    function addXP(amount) {
        let currentXp = parseInt(localStorage.getItem('user_xp')) || 0;
        localStorage.setItem('user_xp', currentXp + amount);
    }

    // Lancement au chargement
    document.addEventListener('DOMContentLoaded', () => {
        let done = JSON.parse(localStorage.getItem('done_chapters')) || [];
        done.forEach(id => {
            let el = document.getElementById('card-' + id);
            if(el) el.classList.add('is-completed');
        });
        updateProg();
    });
</script>
{% endblock %}