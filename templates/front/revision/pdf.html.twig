{% extends 'base.html.twig' %}

{% block title %}BacLab | {{ matiere.nom }}{% endblock %}

{% block body %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        --success-green: #4ade80;
    }

    /* --- HERO & DASHBOARD --- */
    .hero-section {
        background: var(--primary-gradient);
        padding: 130px 0 100px;
        clip-path: ellipse(150% 100% at 50% 0%);
        color: white;
    }

    .progress-container {
        max-width: 500px;
        margin: 20px auto 0;
        padding: 0 15px;
    }

    .progress {
        height: 12px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50px;
        overflow: hidden;
    }

    .progress-bar {
        background-color: var(--success-green) !important;
        transition: width 0.8s ease;
        box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
    }

    /* --- CHAPTER CARDS --- */
    .chapters-grid {
        margin-top: -60px;
        padding-bottom: 80px;
    }

    .chapter-card {
        border: none;
        border-radius: 25px;
        background: #ffffff;
        transition: var(--transition);
        height: 100%;
        display: flex;
        flex-direction: column;
        border: 2px solid transparent;
    }

    .chapter-card.is-completed {
        border-color: var(--success-green);
    }

    .chapter-card:hover {
        transform: translateY(-12px);
        box-shadow: 0 20px 40px rgba(118, 75, 162, 0.15);
    }

    .chapter-header {
        height: 120px;
        background: linear-gradient(45deg, #f3f4f7, #e2e8f0);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .chapter-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.75rem;
        color: #764ba2;
    }

    /* --- ACTION BUTTONS --- */
    .action-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-action {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
        cursor: pointer;
        background: #f8f9fa;
        color: #764ba2;
    }

    .btn-audio.playing {
        background: #ff4757;
        color: white;
        animation: pulse 1.5s infinite;
    }

    .btn-check.completed {
        background: var(--success-green) !important;
        color: white !important;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
    }

    .btn-read {
        background: var(--primary-gradient);
        color: white !important;
        border-radius: 12px;
        padding: 12px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        margin-top: auto;
    }

    .animate-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="hero-section text-center">
    <div class="container animate-up">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-center mb-4 bg-transparent">
                <li class="breadcrumb-item"><a href="{{ path('app_revision_filieres') }}" class="text-white-50 text-decoration-none">Filières</a></li>
                <li class="breadcrumb-item"><a href="{{ path('app_revision_matieres', {id: matiere.filiere.id}) }}" class="text-white-50 text-decoration-none">{{ matiere.filiere.nom }}</a></li>
                <li class="breadcrumb-item active text-white fw-bold">{{ matiere.nom }}</li>
            </ol>
        </nav>
        <h1 class="display-4 fw-bold mb-2">Supports de Révision</h1>
        
        <div class="progress-container">
            <div class="d-flex justify-content-between small fw-bold mb-2">
                <span>Ma progression</span>
                <span id="prog-val">0%</span>
            </div>
            <div class="progress">
                <div id="prog-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<div class="container chapters-grid">
    <div class="row g-4">
        {% for c in chapitres %}
            <div class="col-lg-4 col-md-6 animate-up" style="animation-delay: {{ loop.index * 0.1 }}s">
                <div class="card chapter-card shadow-sm" id="card-{{ c.id }}">
                    <div class="chapter-header">
                        <span class="chapter-badge">PDF</span>
                        <i class="fas fa-file-pdf fa-3x text-primary" style="opacity: 0.2;"></i>
                    </div>
                    
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted small"><i class="far fa-clock"></i> Chapitre</span>
                            
                            <div class="action-buttons">
                                <button class="btn-action btn-audio" onclick="speak('{{ c.titre|e('js') }}', this)" title="Écouter le titre">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <button class="btn-action btn-check" onclick="toggleTask('{{ c.id }}', this)" title="Marquer comme terminé">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                        <h4 class="fw-bold mb-4" style="color: #2d3436; flex-grow: 1;">{{ c.titre }}</h4>
                        
                        <a href="{{ asset('uploads/pdf/' ~ c.contenu) }}" target="_blank" class="btn btn-read">
                            <i class="fas fa-eye me-2"></i> Lire le cours
                        </a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12 text-center py-5">
                <div class="bg-white p-5 rounded-5 shadow-sm">
                    <h3 class="text-muted">Aucun chapitre disponible</h3>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="text-center mt-5">
        <a href="{{ path('app_revision_matieres', {'id': matiere.filiere.id}) }}" class="btn btn-light rounded-pill px-5 shadow-sm border fw-bold text-primary text-decoration-none">
            <i class="fas fa-arrow-left me-2"></i> Retour
        </a>
    </div>
</div>

<script>
    // --- FONCTION AUDIO ---
    function speak(text, btn) {
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            if (btn.classList.contains('playing')) {
                resetAudio();
                return;
            }
        }
        resetAudio();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'fr-FR';
        msg.onstart = () => btn.classList.add('playing');
        msg.onend = () => resetAudio();
        window.speechSynthesis.speak(msg);
    }

    function resetAudio() {
        document.querySelectorAll('.btn-audio').forEach(b => b.classList.remove('playing'));
    }

    // --- FONCTION PROGRESSION (DASHBOARD) ---
    function updateProgress() {
        const total = document.querySelectorAll('.btn-check').length;
        const done = document.querySelectorAll('.btn-check.completed').length;
        const percent = total > 0 ? Math.round((done / total) * 100) : 0;
        
        const bar = document.getElementById('prog-bar');
        const val = document.getElementById('prog-val');
        
        if (bar) bar.style.width = percent + '%';
        if (val) val.innerText = percent + '%';
    }

    function toggleTask(id, btn) {
        btn.classList.toggle('completed');
        const card = document.getElementById('card-' + id);
        if (card) card.classList.toggle('is-completed');
        
        // Sauvegarde unique par matière
        let storageKey = 'done_chapters_matiere_{{ matiere.id }}';
        let done = JSON.parse(localStorage.getItem(storageKey)) || [];
        
        if (btn.classList.contains('completed')) {
            if (!done.includes(id)) done.push(id);
        } else {
            done = done.filter(i => i !== id);
        }
        
        localStorage.setItem(storageKey, JSON.stringify(done));
        updateProgress();
    }

    // --- INITIALISATION ---
    document.addEventListener('DOMContentLoaded', () => {
        let storageKey = 'done_chapters_matiere_{{ matiere.id }}';
        const done = JSON.parse(localStorage.getItem(storageKey)) || [];
        
        document.querySelectorAll('.btn-check').forEach(btn => {
            const id = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (done.includes(id)) {
                btn.classList.add('completed');
                const card = document.getElementById('card-' + id);
                if (card) card.classList.add('is-completed');
            }
        });
        updateProgress();
    });

    window.onbeforeunload = () => window.speechSynthesis.cancel();
</script>
{% endblock %}