{% extends 'back_base.html.twig' %}

{% block title %}Modérateurs - {{ fiche.title }} - Admin{% endblock %}

{% block body %}
<div class="admin-header">
    <div>
        <h1 class="admin-title">
            <i class="fa-solid fa-users"></i>
            Gestion des modérateurs
        </h1>
        <p class="admin-subtitle">{{ fiche.title }} - {{ moderateurs|length }} modérateur(s)</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ path('admin_fiche_show', {id: fiche.id}) }}" class="btn admin-btn admin-btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Retour
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- Add Moderator -->
    <div class="col-lg-4">
        <div class="admin-card">
            <div class="card-header-admin">
                <h5 class="mb-0">
                    <i class="fa-solid fa-user-plus"></i>
                    Ajouter un modérateur
                </h5>
            </div>
            <div class="card-body-admin">
                {% if availableUsers is empty %}
                    <div class="empty-state-mini">
                        <i class="fa-solid fa-users-slash"></i>
                        <p>Tous les utilisateurs sont déjà modérateurs</p>
                    </div>
                {% else %}
                    <form method="post" action="{{ path('admin_fiche_add_moderateur', {id: fiche.id}) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('add_moderateur_' ~ fiche.id) }}">
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fa-solid fa-user"></i> Utilisateur
                            </label>
                            <select name="utilisateur_id" class="form-select admin-input" required>
                                <option value="">Sélectionner un utilisateur</option>
                                {% for user in availableUsers %}
                                    <option value="{{ user.id }}">
                                        {% if user.profil %}
                                            {{ user.profil.nom }} {{ user.profil.prenom }} ({{ user.email }})
                                        {% else %}
                                            {{ user.email }}
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <button type="submit" class="btn admin-btn admin-btn-primary w-100">
                            <i class="fa-solid fa-plus"></i> Ajouter
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Moderators List -->
    <div class="col-lg-8">
        <div class="admin-card">
            <div class="card-header-admin">
                <h5 class="mb-0">
                    <i class="fa-solid fa-list"></i>
                    Liste des modérateurs
                </h5>
            </div>
            <div class="card-body-admin">
                {% if moderateurs is empty %}
                    <div class="empty-state">
                        <i class="fa-solid fa-users-slash"></i>
                        <p>Aucun modérateur</p>
                    </div>
                {% else %}
                    <div class="moderateurs-grid">
                        {% for moderateur in moderateurs %}
                            <div class="moderateur-card">
                                <div class="moderateur-avatar-admin">
                                    {% if moderateur.utilisateur and moderateur.utilisateur.profil and moderateur.utilisateur.profil.nom %}
                                        {{ moderateur.utilisateur.profil.nom|first|upper }}
                                    {% elseif moderateur.utilisateur %}
                                        {{ moderateur.utilisateur.email|first|upper }}
                                    {% else %}
                                        <i class="fa-solid fa-user"></i>
                                    {% endif %}
                                </div>
                                
                                <div class="moderateur-info-admin">
                                    <div class="moderateur-name-admin">
                                        {% if moderateur.utilisateur and moderateur.utilisateur.profil %}
                                            {{ moderateur.utilisateur.profil.nom }} {{ moderateur.utilisateur.profil.prenom }}
                                        {% elseif moderateur.utilisateur %}
                                            {{ moderateur.utilisateur.email }}
                                        {% else %}
                                            Utilisateur supprimé
                                        {% endif %}
                                    </div>
                                    <div class="moderateur-email-admin">
                                        {% if moderateur.utilisateur %}
                                            <i class="fa-solid fa-envelope"></i>
                                            {{ moderateur.utilisateur.email }}
                                        {% endif %}
                                    </div>
                                    
                                    {% if moderateur.isOwner %}
                                        <span class="badge-owner">
                                            <i class="fa-solid fa-crown"></i> Propriétaire
                                        </span>
                                    {% else %}
                                        <span class="badge-moderator">
                                            <i class="fa-solid fa-user-shield"></i> Modérateur
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <div class="moderateur-actions-admin">
                                    <form method="post" action="{{ path('admin_fiche_toggle_owner', {ficheId: fiche.id, moderateurId: moderateur.id}) }}" class="d-inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('toggle_owner_' ~ moderateur.id) }}">
                                        <button type="submit" class="btn btn-sm admin-btn-icon" 
                                                title="{{ moderateur.isOwner ? 'Retirer propriétaire' : 'Définir comme propriétaire' }}">
                                            <i class="fa-solid {{ moderateur.isOwner ? 'fa-crown-slash' : 'fa-crown' }}"></i>
                                        </button>
                                    </form>
                                    
                                    {% if not moderateur.isOwner %}
                                        <button type="button" class="btn btn-sm admin-btn-icon admin-btn-danger" 
                                                onclick="confirmRemove({{ moderateur.id }})"
                                                data-token="{{ csrf_token('remove_moderateur_' ~ moderateur.id) }}"
                                                title="Retirer">
                                            <i class="fa-solid fa-user-minus"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Remove Moderator Modal -->
<div class="modal fade" id="removeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid fa-triangle-exclamation text-danger"></i>
                    Confirmer le retrait
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir retirer ce modérateur ?</p>
                <p class="text-warning mb-0">
                    <i class="fa-solid fa-info-circle"></i>
                    Il perdra tous ses droits d'édition sur cette fiche.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn admin-btn admin-btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <form method="post" id="removeForm">
                    <button type="submit" class="btn admin-btn admin-btn-danger">
                        <i class="fa-solid fa-user-minus"></i> Retirer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmRemove(moderateurId) {
    const modal = new bootstrap.Modal(document.getElementById('removeModal'));
    const form = document.getElementById('removeForm');
    
    form.action = '{{ path('admin_fiche_remove_moderateur', {ficheId: fiche.id, moderateurId: 'PLACEHOLDER_ID'}) }}'.replace('PLACEHOLDER_ID', moderateurId);
    
    // Add CSRF token
    const existingToken = form.querySelector('input[name="_token"]');
    if (existingToken) {
        existingToken.remove();
    }
    
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = '_token';
    const removeBtn = document.querySelector(`button[onclick="confirmRemove(${moderateurId})"]`);
    tokenInput.value = removeBtn ? removeBtn.dataset.token : '';
    form.appendChild(tokenInput);
    
    modal.show();
}
</script>

<style>
.empty-state-mini {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--muted);
}

.empty-state-mini i {
    font-size: 2rem;
    opacity: 0.3;
    margin-bottom: 0.75rem;
    display: block;
}

.empty-state-mini p {
    margin: 0;
    font-size: 0.875rem;
}

.moderateurs-grid {
    display: grid;
    gap: 1rem;
}

.moderateur-card {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border);
    border-radius: 14px;
    transition: all 0.2s ease;
}

.moderateur-card:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(109, 91, 255, 0.3);
    transform: translateX(4px);
}

.moderateur-avatar-admin {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--grad1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 1.5rem;
    flex-shrink: 0;
    box-shadow: 0 4px 15px rgba(109, 91, 255, 0.3);
}

.moderateur-info-admin {
    flex: 1;
}

.moderateur-name-admin {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.375rem;
}

.moderateur-email-admin {
    font-size: 0.875rem;
    color: var(--muted);
    margin-bottom: 0.625rem;
}

.moderateur-email-admin i {
    margin-right: 0.375rem;
}

.badge-owner {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 10px;
    font-weight: 700;
    font-size: 0.875rem;
    color: #F59E0B;
}

.badge-moderator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(109, 91, 255, 0.15);
    border: 1px solid rgba(109, 91, 255, 0.3);
    border-radius: 10px;
    font-weight: 700;
    font-size: 0.875rem;
    color: #6D5BFF;
}

.moderateur-actions-admin {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}
</style>
{% endblock %}
