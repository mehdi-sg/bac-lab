{% extends 'fiche/_layout.html.twig' %}

{% block title %}{{ fiche.title }} - BAC Lab{% endblock %}

{% block fiche_title %}
    <i class="fa fa-graduation-cap mr-2"></i>
    {{ fiche.title }}
{% endblock %}

{% block fiche_subtitle %}
    {% if is_moderateur %}
        <span class="badge bg-success me-2">
            <i class="fa fa-check-circle mr-1"></i>Vous √™tes mod√©rateur
        </span>
    {% endif %}
    {% if is_favorited %}
        <span class="badge bg-danger me-2">
            <i class="fa fa-heart mr-1"></i>Favori
        </span>
    {% endif %}
    <span>
        <i class="fa fa-calendar-alt mr-1"></i>
        Cr√©√©e le {{ fiche.createdAt|date('d/m/Y') }}
    </span>
{% endblock %}


{% block fiche_header_actions %}
    <a href="{{ path('fiche_index') }}" class="btn btn-light btn-lg rounded-pill shadow-sm me-2">
        <i class="fa fa-arrow-left mr-1"></i>Retour
    </a>
    {% if app.user %}
        <form action="{{ path('fiche_toggle_favorite', {'id': fiche.id}) }}" method="post" class="d-inline">
            <input type="hidden" name="_token" value="{{ csrf_token('toggle_favorite_' ~ fiche.id) }}">
            <button type="submit" class="btn btn-lg rounded-pill shadow-sm me-2 {{ is_favorited ? 'btn-danger' : 'btn-outline-danger' }}">
                <i class="fa {{ is_favorited ? 'fa-heart' : 'fa-heart-o' }} mr-1"></i>
                {{ is_favorited ? 'Retirer des favoris' : 'Ajouter aux favoris' }}
            </button>
        </form>
    {% endif %}
    {% if is_moderateur %}
        <div class="btn-group shadow-sm">
            <a href="{{ path('fiche_edit', {id: fiche.id}) }}" class="btn btn-primary btn-lg rounded-pill">
                <i class="fa fa-edit mr-1"></i>Modifier
            </a>
            <button type="button" class="btn btn-danger btn-lg rounded-pill" data-toggle="modal" data-target="#deleteModal">
                <i class="fa fa-trash mr-1"></i>
            </button>
        </div>
    {% endif %}
{% endblock %}


{% block fiche_content %}

<!-- Content Card -->
<div class="card bg-white bg-opacity-25 border-0 shadow-lg mb-5">
    <div class="fiche-content p-5">

    {{
        fiche.content
        |nl2br
        |replace({
            '!!': '<div class="fiche-block fiche-warning"><strong>‚ö†Ô∏è </strong>',
            '>>': '<div class="fiche-block fiche-example"><strong>üí° Exemple :</strong> '
        })
        |replace({
            '</div><br />': '</div>'
        })
        |raw
    }}

    </div>
</div>

<!-- Moderation Section -->
<div class="row g-4">
    <div class="col-md-6">
        <!-- Moderators List -->
        <div class="card border-0 shadow-lg h-100">
            <div class="card-header bg-gradient-primary text-white py-4">
                <h5 class="mb-0">
                    <i class="fa fa-users mr-2"></i>
                    Mod√©rateurs
                </h5>
            </div>
            <div class="card-body bg-white">
                {% if fiche.moderateurs is empty %}
                    <p class="text-muted mb-0 text-center py-4">
                        <i class="fa fa-user-plus fa-3x mb-3 text-muted"></i><br>
                        Aucun mod√©rateur.
                    </p>
                {% else %}
                    <ul class="list-group list-group-flush">
                        {% for moderateur in fiche.moderateurs %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 mr-3">
                                            <i class="fa fa-user text-primary"></i>
                                        </div>
                                        <div>
                                            <strong>
                                                {% if moderateur.utilisateur and moderateur.utilisateur.profil %}
                                                    {{ moderateur.utilisateur.profil.nom }} {{ moderateur.utilisateur.profil.prenom }}
                                                {% elseif moderateur.utilisateur %}
                                                    {{ moderateur.utilisateur.email }}
                                                {% else %}
                                                    Utilisateur inconnu
                                                {% endif %}
                                            </strong>
                                        </div>
                                    </div>
                                </span>
                                {% if moderateur.isOwner %}
                                    <span class="badge bg-warning text-dark rounded-pill px-3">
                                        <i class="fa fa-star mr-1"></i>Propri√©taire
                                    </span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <!-- Join Request Form (for non-moderators) -->
        {% if app.user and not is_moderateur %}
            <div class="card border-0 shadow-lg h-100">
                <div class="card-header bg-gradient-success text-white py-4">
                    <h5 class="mb-0">
                        <i class="fa fa-user-plus mr-2"></i>
                        Demander √† rejoindre
                    </h5>
                </div>
                <div class="card-body bg-white">
                    <p class="text-muted mb-4">
                        <i class="fa fa-info-circle mr-2"></i>
                        Vous n'√™tes pas mod√©rateur de cette fiche. Souhaitez-vous demander √† rejoindre l'√©quipe ?
                    </p>
                    <form action="{{ path('fiche_join_request', {'id': fiche.id}) }}" method="post">
                        <input type="hidden" name="_token" value="{{ csrf_token('fiche_join_request_' ~ fiche.id) }}">
                        <div class="mb-4">
                            <label for="message" class="form-label text-muted">Message (optionnel)</label>
                            <textarea class="form-control border-0 bg-light rounded-lg" id="message" name="message" rows="4" placeholder="Pr√©sentez-vous bri√®vement..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill shadow-lg">
                            <i class="fa fa-paper-plane mr-2"></i>
                            Envoyer ma demande
                        </button>
                    </form>
                </div>
            </div>
        {% endif %}

        <!-- Pending Requests (for owners only) -->
        {% if is_owner %}
            <div class="card border-0 shadow-lg h-100">
                <div class="card-header bg-gradient-warning text-dark py-4">
                    <h5 class="mb-0">
                        <i class="fa fa-clock-o mr-2"></i>
                        Demandes en attente
                    </h5>
                </div>
                <div class="card-body bg-white">
                    {% set pending_requests = fiche.joinRequests|filter(r => r.status == 'pending') %}
                    {% if pending_requests is empty %}
                        <div class="text-center py-4">
                            <i class="fa fa-check-circle fa-4x text-success mb-3"></i>
                            <p class="text-muted mb-0">Aucune demande en attente.</p>
                        </div>
                    {% else %}
                        {% for request in pending_requests %}
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex align-items-start">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 mr-3">
                                        <i class="fa fa-user text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="mb-1">
                                            <strong>
                                                {% if request.utilisateur.profil %}
                                                    {{ request.utilisateur.profil.nom }} {{ request.utilisateur.profil.prenom }}
                                                {% else %}
                                                    {{ request.utilisateur.email }}
                                                {% endif %}
                                            </strong>
                                            <small class="text-muted">a demand√© √† rejoindre</small>
                                        </p>
                                        {% if request.message %}
                                            <p class="text-muted mb-2">
                                                <em class="bg-light rounded p-2 d-block">¬´ {{ request.message }} ¬ª</em>
                                            </p>
                                        {% endif %}
                                        <small class="text-muted d-block mb-3">
                                            <i class="fa fa-clock mr-1"></i>
                                            {{ request.createdAt|date('d/m/Y H:i') }}
                                        </small>
                                        <div class="d-flex gap-2">
                                            <form action="{{ path('fiche_approve_request', {'ficheId': fiche.id, 'requestId': request.id}) }}" method="post">
                                                <input type="hidden" name="_token" value="{{ csrf_token('approve_request_' ~ request.id) }}">
                                                <button type="submit" class="btn btn-success btn-sm rounded-pill">
                                                    <i class="fa fa-check mr-1"></i>Accepter
                                                </button>
                                            </form>
                                            <form action="{{ path('fiche_reject_request', {'ficheId': fiche.id, 'requestId': request.id}) }}" method="post">
                                                <input type="hidden" name="_token" value="{{ csrf_token('reject_request_' ~ request.id) }}">
                                                <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill">
                                                    <i class="fa fa-times mr-1"></i>Refuser
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Modal -->
{% if is_moderateur %}
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="fa fa-exclamation-triangle mr-2"></i>
                        Confirmer la suppression
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fa fa-trash fa-4x text-danger opacity-50"></i>
                    </div>
                    <p class="text-center">√ätes-vous s√ªr de vouloir supprimer cette fiche ?</p>
                    <h6 class="text-center text-primary mb-0">{{ fiche.title }}</h6>
                    <p class="text-danger text-center mt-3 mb-0">
                        <small><i class="fa fa-exclamation-circle mr-1"></i>Cette action est irr√©versible et supprimera √©galement toutes les versions.</small>
                    </p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill" data-dismiss="modal">
                        <i class="fa fa-times mr-1"></i>Annuler
                    </button>
                    <form action="{{ path('fiche_delete', {'id': fiche.id}) }}" method="post" class="d-inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_fiche_' ~ fiche.id) }}">
                        <button type="submit" class="btn btn-danger rounded-pill">
                            <i class="fa fa-trash mr-1"></i>Supprimer
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .fiche-content {
        font-size: 1.1rem;
        line-height: 1.8;
    }
</style>
{% endblock %}
