{% extends 'fiche/_layout.html.twig' %}

{% block css %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('front/css/fiche-editor.css') }}">
{% endblock %}

{% block title %}‚úèÔ∏è Modifier la fiche{% endblock %}

{% block fiche_title %}‚úèÔ∏è Modifier la fiche{% endblock %}
{% block fiche_subtitle %}√âcris ‚Üí structure ‚Üí visualise instantan√©ment.{% endblock %}

{% block fiche_content %}

<div class="row justify-content-center">
    <div class="col-12 col-xl-11">

        <div class="card border-0 shadow-lg fiche-editor-shell">
            <div class="card-body p-4 p-lg-5">

                {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

                <!-- TOP: TITLE + FILIERE + STATS -->
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-lg-5">
                        <label for="{{ form.title.vars.id }}" class="form-label fw-semibold">üìå Titre de la fiche</label>
                        {{ form_widget(form.title, {
                            'attr': {
                                'class': 'form-control form-control-lg fiche-input',
                                'placeholder': 'Ex: D√©rivation, Suites, Probabilit√©s...'
                            }
                        }) }}
                        {{ form_errors(form.title) }}
                        {% if not form.title.vars.valid %}
                        {% else %}
                            <div class="form-text">
                                Un titre clair = une fiche retrouv√©e plus vite.
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-lg-3">
                        <label class="form-label fw-semibold">üéì Fili√®re</label>
                        <div class="fiche-form-select-wrapper">
                            <select name="{{ form.filiere.vars.full_name }}" id="filiere_native" class="fiche-form-select-native">
                                <option value="">S√©lectionnez une fili√®re</option>
                                {% for choice in form.filiere.vars.choices %}
                                    <option value="{{ choice.value }}" {{ form.filiere.vars.value == choice.value ? 'selected' : '' }}>
                                        {{ choice.label }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="fiche-form-select-custom" id="filiere_form_custom">
                                <div class="fiche-form-select-trigger">
                                    <span class="fiche-form-select-value">
                                        {% if form.filiere.vars.value %}
                                            {% for choice in form.filiere.vars.choices %}
                                                {% if choice.value == form.filiere.vars.value %}
                                                    {{ choice.label }}
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            S√©lectionnez une fili√®re
                                        {% endif %}
                                    </span>
                                    <i class="fa fa-chevron-down fiche-form-select-arrow"></i>
                                </div>
                                <div class="fiche-form-select-dropdown">
                                    <div class="fiche-form-select-option {{ form.filiere.vars.value == '' ? 'selected' : '' }}" data-value="">
                                        S√©lectionnez une fili√®re
                                    </div>
                                    {% for choice in form.filiere.vars.choices %}
                                        <div class="fiche-form-select-option {{ form.filiere.vars.value == choice.value ? 'selected' : '' }}" data-value="{{ choice.value }}">
                                            {{ choice.label }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="fiche-stats">
                            <div class="fiche-stat">
                                <div class="fiche-stat-label">Mots</div>
                                <div class="fiche-stat-value" id="statWords">0</div>
                            </div>
                            <div class="fiche-stat">
                                <div class="fiche-stat-label">Lignes</div>
                                <div class="fiche-stat-value" id="statLines">0</div>
                            </div>
                            <div class="fiche-stat">
                                <div class="fiche-stat-label">Lecture</div>
                                <div class="fiche-stat-value" id="statRead">~0 min</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOOLBAR -->
                <div class="fiche-toolbar2 mb-3">
                    <button type="button" class="chip chip-warn" onclick="insertText('!! D√©finition\\n')">
                        <span class="chip-ico">‚ö†Ô∏è</span><span class="chip-txt">Important</span><span class="chip-kbd">Ctrl+1</span>
                    </button>

                    <button type="button" class="chip chip-info" onclick="insertText('>> Exemple\\n')">
                        <span class="chip-ico">üìò</span><span class="chip-txt">Exemple</span><span class="chip-kbd">Ctrl+2</span>
                    </button>

                    <button type="button" class="chip chip-good" onclick="insertText('!!+ Astuce\\n')">
                        <span class="chip-ico">üí°</span><span class="chip-txt">Astuce</span><span class="chip-kbd">Ctrl+3</span>
                    </button>

                    <button type="button" class="chip chip-bad" onclick="insertText('!!- Pi√®ge\\n')">
                        <span class="chip-ico">üö´</span><span class="chip-txt">Pi√®ge</span><span class="chip-kbd">Ctrl+4</span>
                    </button>

                    <button type="button" class="chip chip-ques" onclick="insertText('?? Question\\n')">
                        <span class="chip-ico">‚ùì</span><span class="chip-txt">Question</span><span class="chip-kbd">Ctrl+5</span>
                    </button>

                    <button type="button" class="chip chip-sec" onclick="insertText('== Section\\n')">
                        <span class="chip-ico">üß©</span><span class="chip-txt">Section</span><span class="chip-kbd">Ctrl+6</span>
                    </button>

                    <button class="chip chip-ghost ms-auto" type="button"
                            data-bs-toggle="collapse" data-bs-target="#syntaxHelp"
                            aria-expanded="false" aria-controls="syntaxHelp">
                        <span class="chip-ico">‚ÑπÔ∏è</span><span class="chip-txt">Aide syntaxe</span>
                    </button>
                </div>

                <!-- SYNTAX HELP -->
                <div class="collapse" id="syntaxHelp">
                    <div class="fiche-help mb-4">
                        <div class="fiche-help-title">üß† Syntaxe p√©dagogique</div>
                        <div class="fiche-help-grid">
                            <div class="help-item"><span class="badge bg-warning text-dark">!!</span> Notion importante / d√©finition</div>
                            <div class="help-item"><span class="badge bg-info text-dark">>></span> Exemple / application</div>
                            <div class="help-item"><span class="badge bg-success">!!+</span> Astuce / m√©thode</div>
                            <div class="help-item"><span class="badge bg-danger">!!-</span> Pi√®ge / erreur fr√©quente</div>
                            <div class="help-item"><span class="badge bg-primary">??</span> Question √† retenir</div>
                            <div class="help-item"><span class="badge bg-secondary">==</span> Titre de section</div>
                        </div>

                        <div class="fiche-help-inline mt-3">
                            <span class="text-muted me-2">Inline :</span>
                            <code>**gras**</code>
                            <code>_italique_</code>
                            <code>`terme`</code>
                            <code>[[mot-cl√©]]</code>
                            <code>- liste</code>
                            <code>-></code>
                        </div>
                    </div>
                </div>

                <!-- EDITOR + PREVIEW -->
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="fiche-panel">
                            <div class="fiche-panel-head">
                                <div class="fiche-panel-title">‚úçÔ∏è √âdition</div>
                                <div class="fiche-panel-hint">Structure en sections, ajoute des exemples.</div>
                            </div>

                            {{ form_widget(form.content, {
                                'attr': {
                                    'class': 'form-control fiche-textarea2',
                                    'rows': 16,
                                    'id': 'fiche_content',
                                    'placeholder': "== Notions cl√©s\n!! D√©finition...\n>> Exemple...\n- Point 1\n- Point 2\n\nAstuce: **important** et `termes`"
                                }
                            }) }}
                            {{ form_errors(form.content) }}

                            <div class="fiche-mini-hint">
                                Tip: <code>==</code> pour structurer. <code>>></code> pour donner des exemples.
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="fiche-panel fiche-preview-sticky">
                            <div class="fiche-panel-head">
                                <div class="fiche-panel-title">üëÄ Aper√ßu</div>
                                <div class="fiche-panel-hint">Rendu p√©dagogique (s√©curis√©).</div>
                            </div>

                            <div id="preview" class="fiche-preview2"></div>

                            <div class="fiche-mini-hint">
                                Aper√ßu s√©curis√© (anti XSS) : aucun HTML ins√©r√© ne sera ex√©cut√©.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM BAR -->
                <div class="fiche-bottombar mt-4">
                    <div class="d-flex gap-3 flex-wrap align-items-center justify-content-between">
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{{ path('fiche_show', {id: fiche.id}) }}" class="btn btn-glass btn-glass-secondary">
                                ‚Üê Annuler
                            </a>
                            <a href="{{ path('fiche_history', {id: fiche.id}) }}" class="btn btn-glass btn-glass-secondary">
                                üïí Historique
                            </a>
                            
                            <!-- CHECKBOX PERSONNALIS√â POUR FICHE PUBLIQUE -->
                            {% if form.isPublic is defined %}
                                <div class="form-check-custom ms-xl-2">
                                    {{ form_widget(form.isPublic, {
                                        'attr': {
                                            'class': 'form-check-input fiche-public-checkbox',
                                            'id': 'fiche_isPublic'
                                        }
                                    }) }}
                                    <label for="fiche_isPublic" class="form-check-label fiche-public-label">üåê Fiche publique</label>
                                    <div class="fiche-public-hint">Visible par tous les utilisateurs</div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex gap-3 align-items-center flex-wrap">
                            <button class="btn btn-glass btn-glass-primary" type="submit" id="submitBtn">
                                üíæ Enregistrer
                            </button>
                        </div>
                    </div>
                </div>

                {% do form.filiere.setRendered %}
                {{ form_end(form) }}

            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block js %}
    {{ parent() }}
    <script src="{{ asset('front/js/fiche-editor.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Custom Form Select for Filiere
            const customSelect = document.getElementById('filiere_form_custom');
            const nativeSelect = document.getElementById('filiere_native');
            
            if (customSelect && nativeSelect) {
                const trigger = customSelect.querySelector('.fiche-form-select-trigger');
                const valueDisplay = customSelect.querySelector('.fiche-form-select-value');
                const dropdown = customSelect.querySelector('.fiche-form-select-dropdown');
                const options = dropdown.querySelectorAll('.fiche-form-select-option');
                
                trigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    customSelect.classList.toggle('active');
                });
                
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.dataset.value;
                        nativeSelect.value = value;
                        valueDisplay.textContent = this.textContent.replace('‚úì ', '');
                        options.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        customSelect.classList.remove('active');
                    });
                });
                
                document.addEventListener('click', function(e) {
                    if (!customSelect.contains(e.target)) {
                        customSelect.classList.remove('active');
                    }
                });
            }
        });
    </script>
{% endblock %}
